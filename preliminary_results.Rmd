---
title: "Preliminary results"
author: "Adriana Clavijo Daza"
date: "2022-11-14"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

```{r libs, echo = FALSE}
library(readxl)
library(tidyr)
library(dplyr)
library(stringr)
library(ggplot2)
library(TraMineR)
```

```{r data, echo = FALSE, cache=TRUE}
cs_levels <- 1:6
cs_labels <- c("Single", "Married", "Registered partnership", 
               "Same-sex partnership", "Divorced", "Widowed")

rs_levels <- 1:4
rs_labels <- c("No relationship", "Relationship", 
               "Open relationship", "Changing relationships")

liv_levels <- 0:2
liv_labels <- c("No partner", "Yes", "No")

file <- "../Data_original/Tracker_Uni-Zurich_Modified.xlsx"

raw_data <- read_excel(file)

raw_data <- raw_data %>% 
  select_if(~!all(is.na(.)))

new_names <- vector(mode = "character")

for (i in 1:12){
  new_names[2*(i-1)+1] <- paste0("Start-", i)
  new_names[2*(i-1)+2] <- paste0("End-", i)
}

colnames(raw_data)[1] <- "Id"
colnames(raw_data)[58] <- "Age"
colnames(raw_data)[59:82] <- new_names
colnames(raw_data)[83:94] <- paste0("Civil-", 1:12)
colnames(raw_data)[95:106] <- paste0("Relationship-", 1:12)
colnames(raw_data)[119:130] <- paste0("Children-", 1:12)
colnames(raw_data)[131:142] <- paste0("Living-", 1:12)

raw_data <- raw_data %>% 
  select(c(1, 58:106, 119:142)) 

raw_data <- raw_data %>% 
  pivot_longer(cols = starts_with("Start"),
               names_to = "Phase",
               names_prefix = "Start-",
               values_to = "Start_age",
               values_drop_na = TRUE) %>% 
  pivot_longer(cols = starts_with("End"),
               names_to = "Match2",
               names_prefix = "End-",
               values_to = "End_age",
               values_drop_na = TRUE) %>% 
  pivot_longer(cols = starts_with("Civil"),
               names_to = "Match3",
               names_prefix = "Civil-",
               values_to = "Civil_status",
               values_drop_na = TRUE) %>% 
  pivot_longer(cols = starts_with("Relationship"),
               names_to = "Match4",
               names_prefix = "Relationship-",
               values_to = "Relationship_status",
               values_drop_na = TRUE) %>% 
  pivot_longer(cols = starts_with("Children"),
               names_to = "Match5",
               names_prefix = "Children-",
               values_to = "Children",
               values_drop_na = TRUE) %>% 
  pivot_longer(cols = starts_with("Living"),
               names_to = "Match6",
               names_prefix = "Living-",
               values_to = "Living_situation",
               values_drop_na = TRUE) %>% 
  filter(Phase == Match2,
         Phase == Match3,
         Phase == Match4,
         Phase == Match5,
         Phase == Match6,
         Start_age >= 15,
         !Id %in% c("zr34u", "EN61O", "DN15U"),
         !(Id == "GB28U" & Phase == "4")) %>% 
  select(-contains("Match")) %>% 
  mutate(Civil_status = factor(Civil_status, levels = cs_levels, labels = cs_labels),
         Relationship_status = factor(Relationship_status, levels = rs_levels, labels = rs_labels),
         Phase = as.numeric(Phase),
         Living_situation = factor(Living_situation, levels = liv_levels, labels = liv_labels),
         Children = case_when(
           Children == 0 ~ "No",
           is.na(Children) ~ "No",
           Children > 0 ~ "Yes"
         )
         )

tst <- raw_data %>% 
  mutate(
    Status= case_when(
      Relationship_status == "No relationship" & Civil_status == "Single" & Children == "No" ~ 1,
      Relationship_status == "No relationship" & Civil_status == "Single" & Children == "Yes" ~ 5,
      Relationship_status %in% c("Relationship", "Open relationship") & Civil_status == "Single" & Children == "No" & Living_situation == "No" ~ 2,
      Relationship_status %in% c("Relationship", "Open relationship") & Civil_status == "Single" & Children == "No" & Living_situation == "Yes"  ~ 9,
      Relationship_status %in% c("Relationship", "Open relationship") & Civil_status == "Single" & Children == "Yes" & Living_situation == "No" ~ 6,
      Relationship_status %in% c("Relationship", "Open relationship") & Civil_status == "Single" & Children == "Yes"  & Living_situation == "Yes" ~ 10,
      Relationship_status == "Changing relationships" & Civil_status == "Single" & Children == "No" ~ 3,
      Relationship_status == "Changing relationships" & Civil_status == "Single" & Children == "Yes" ~ 7,
      Civil_status %in% c("Married", "Registered partnership") & Children == "No" ~ 4,
      Civil_status %in% c("Married", "Registered partnership") & Children == "Yes" ~ 8,
      Relationship_status == "No relationship" & Civil_status == "Divorced" & Children == "No" ~ 1,
      Relationship_status == "No relationship" & Civil_status == "Divorced" & Children == "Yes" ~ 5,
      Relationship_status %in% c("Relationship", "Open relationship") & Civil_status == "Divorced" & Children == "No" & Living_situation == "No" ~ 2,
      Relationship_status %in% c("Relationship", "Open relationship") & Civil_status == "Divorced" & Children == "No" & Living_situation == "Yes" ~ 9,
      Relationship_status %in% c("Relationship", "Open relationship") & Civil_status == "Divorced" & Children == "Yes" & Living_situation == "No" ~ 6,
      Relationship_status %in% c("Relationship", "Open relationship") & Civil_status == "Divorced" & Children == "Yes" & Living_situation == "Yes" ~ 10,
      Relationship_status == "Changing relationships" & Civil_status == "Divorced" & Children == "No" ~ 3,
      Relationship_status == "Changing relationships" & Civil_status == "Divorced" & Children == "Yes" ~ 7,
      Relationship_status == "No relationship" & Civil_status == "Widowed" & Children == "No" ~ 1,
      Relationship_status == "No relationship" & Civil_status == "Widowed" & Children == "Yes" ~ 5,
      Relationship_status %in% c("Relationship", "Open relationship") & Civil_status == "Widowed" & Children == "No" & Living_situation == "No" ~ 2,
      Relationship_status %in% c("Relationship", "Open relationship") & Civil_status == "Widowed" & Children == "No" & Living_situation == "Yes" ~ 9,
      Relationship_status %in% c("Relationship", "Open relationship") & Civil_status == "Widowed" & Children == "Yes" & Living_situation == "No" ~ 6,
      Relationship_status %in% c("Relationship", "Open relationship") & Civil_status == "Widowed" & Children == "Yes" & Living_situation == "Yes" ~ 10,
      Relationship_status == "Changing relationships" & Civil_status == "Widowed" & Children == "No" ~ 3,
      Relationship_status == "Changing relationships" & Civil_status == "Widowed" & Children == "Yes" ~ 3,
      TRUE ~ 0
      )
    )                

status_levels <- 1:10
status_labels <- c("Single + no ch.",
                   "Relationship + no ch. + not living tog.",
                   "Changing relationships + no ch.",
                   "Married + no ch.",
                   "Single + ch.",
                   "Relationship + ch. + not living tog.",
                   "Changing rel. + ch.",
                   "Married + ch.",
                   "Relationship + no ch. + living tog.",
                   "Relationship + ch. + living tog.")

rh_data <- tst %>% 
  select(-Civil_status, -Relationship_status, -Children) %>% 
  mutate(Status_char = factor(Status, levels = status_levels, labels = status_labels))
```

## About the data

- Psychometric instrument to obtain information about the history of romantic relationships of women aged between 40 and 75 years.
- Part of the Women 40+ Healthy Aging Study (University of Zurich).
- Data collected between June 2017 and February 2018.
- Information about relationship phases starting from the age of 15 years until the current age at the time of the data collection.
- The phases were defined by the start and end age and for each phase and information about civil status, relationship status, living situation, children and quality of the relationship was collected.
- Data from 250 individuals available.


## Data pre-processing

- Manual corrections (unify sequences with example data or exclusion).
- Several checks to exclude sequences with inconsistent data.
- Corrections based on secondary data source.
- Selection of variables to use (five scenarios considered).
- In total, 239 individuals are considered for the analysis.


## Exproratory - Civil status

```{r civil-status}
plot1 <- ggplot(data = raw_data, aes(Civil_status))
plot1 + geom_bar() + geom_text(stat="count", aes(label=..count..), vjust=-1)
```


## Exproratory - Relationship status

```{r relationship-status}
plot2 <- ggplot(data = raw_data, aes(Relationship_status))
plot2 + geom_bar() + geom_text(stat="count", aes(label=..count..), vjust=-1)
```


## Exproratory - Civil & relationship status

```{r both}
ggplot(raw_data, aes(x = Civil_status))+
  geom_bar(
    aes(fill = Relationship_status), stat = "count", color = "white",
    position = position_dodge(0.9)
  )
```


## Exproratory - Living situation

```{r living-situation}
plot4 <- ggplot(data = raw_data, aes(Living_situation))
plot4 + geom_bar() + geom_text(stat="count", aes(label=..count..), vjust=-1)
```


## Exproratory - Children

```{r children}
plot3 <- ggplot(data = raw_data, aes(Children))
plot3 + geom_bar() + geom_text(stat="count", aes(label=..count..), vjust=-1)
```

The instrument asked about the number of children in different phases but it will only be considered the presence/absence of children.


## Considered status

- Single + no children
- Relationship + no children + not living together
- Changing relationships + no children
- Married + no children
- Single + children
- Relationship + children + not living together
- Changing rel. + children
- Married + children
- Relationship + no children + living together
- Relationship + children + living together


## Distribution of status

```{r final-status}
plot5 <- ggplot(data = rh_data, aes(Status_char))
plot5 + geom_bar() + geom_text(stat="count", aes(label=..count..), vjust=-1) + scale_x_discrete(guide = guide_axis(n.dodge=2))
```


## Optimal Matching Analysis (OMA)

- Technique used in social sciences for the comparison of sequences.
- Applications on life course and career path analysis. 
- Given two sequences, it is possible to transform one sequence into another using a set of operations on the states: insert, delete and replace.
- Numerical values are assigned to each of this operations  and are defined in a **cost matrix**. 
- As a result, pairwise distances between the sequences can be obtained to apply a clustering method.


## Cost matrix

```{r cost-matrix, echo=FALSE, message=FALSE}
test <- seqformat(rh_data, from = "SPELL", to = "STS",
                  id = "Id", begin = "Start_age", end = "End_age", 
                  status = "Status", covar = "Age", process = FALSE)

alphabet <- as.character(1:10)

my_seq <- seqdef(test, alphabet = alphabet)

cost_matrix_1 <- seqsubm(my_seq, method = "TRATE")
print(cost_matrix_1, digits = 4)
```


## Clustering

- Agglomerative hierarchical method: Agnes.
- Distance between two clusters is the average of the distances between the points in one cluster and the points in the other cluster.
- 6 clusters chosen.
